# 팀 생성 알고리즘 규칙

## 개요

4명을 두 팀(2v2)으로 편성하는 알고리즘. 공정하고 다양한 경기를 위해 아래 규칙을 우선순위 순서로 적용한다.

---

## 규칙 목록

### 규칙 0 — 전체 경기 횟수 균등 분배 (최우선 선발 기준)
- 모든 선수의 경기 횟수가 비슷하도록, **경기를 적게 한 선수를 먼저 선발**한다.
- 매칭 시작 전 대기열 전체를 경기 횟수 오름차순으로 정렬한다.
- 동점(경기수 같음)이면 기존 대기 순서 유지 (stable sort).

### 규칙 1 — 혼복 우선, 남자 혼복 균등 참여
- 대기열에 여자 2명 이상 + 남자 2명 이상이 있으면 **혼복(여+남 vs 여+남)을 최우선** 구성한다.
- 남자 선수 중 **혼복 출전이 적은 선수를 우선** 선발하여, 모든 남자가 골고루 혼복을 경험하도록 한다.

### 규칙 1.5 — 직전 경기 혼복 참여자 배제
- 직전 경기에서 혼복에 출전한 선수(남·여 모두)는 **다음 경기의 혼복 편성에서 최대한 배제**한다.
- 남자: 직전 경기 혼복 출전자는 혼복 선발 우선순위 최하위.
- 여자: 직전 경기 혼복 출전 여자는 혼복 후보에서 후순위 처리.
- 단, 가용 선수가 부족하여 조건을 충족할 수 없는 경우에는 이 규칙을 완화 적용한다.

### 규칙 1.8 — 여자복식(여복) fallback

- **상위 규칙으로 팀 구성이 불가능할 때** 여자 4명으로 여복을 구성한다.
- 발동 조건: 혼복이나 남복 등 상위 우선순위의 규칙들을 적용하여 팀을 만들 수 없는 상태 (예: 대기열에 남자가 부족하거나 조건에 맞는 조합이 나오지 않아 혼복·남복 구성이 모두 불가능한 경우).
- 선발 방식: 여복 발동 시 선발되는 여자 4명은 남복 구성 시와 마찬가지로 **스코어 점수 기준**으로 최적의 조합을 선발한다.
- 구성 우선순위: 혼복 > 남복 > **여복**(fallback).

### 규칙 2 — 혼복 남자 실력 유사성
- 혼복에 투입할 남자 2명은 **서로 실력이 비슷한 쌍**을 선택한다.
- 혼복 출전 횟수가 같은 후보 중에서 실력 차이가 가장 작은 쌍 선택.

### 규칙 3 — 파트너 실력 유사성 (주요 기준)
- 복식 파트너끼리 실력이 비슷할수록 좋다.
- 점수: `intraDiff = |skill(A1) - skill(A2)| + |skill(B1) - skill(B2)|`
- **낮을수록 좋음** — 가중치 1.5배 적용.

### 규칙 4 — 팀 간 실력 균형 (보조 기준)
- 비슷한 실력자끼리 같은 팀이 되는 것을 지양한다.
- 팀 A와 팀 B의 총 실력 합 차이를 최소화한다.
- 점수: `interDiff = |(skill(A1)+skill(A2)) - (skill(B1)+skill(B2))|`
- **낮을수록 좋음** — 가중치 0.5배 적용 (규칙 3보다 낮은 우선순위).
- 예시: 강자 2명 + 약자 2명 → [강,약] vs [강,약]이 [강,강] vs [약,약]보다 유리.

### 규칙 5 — 파트너 중복 최소화 (최우선 제약)
- 이전에 같이 뛴 파트너와는 되도록 다시 파트너가 되지 않도록 한다.
- 점수: `historyPenalty = partnerCount(A1, A2) + partnerCount(B1, B2)`
- **가중치 10배** — 실력 기반 규칙보다 훨씬 강한 제약.

### 규칙 6 — 휴식 선수 제외
- 휴식 상태인 선수는 자동 매칭 대상에서 **완전히 제외**한다.
- 대기열은 대기 상태인 선수로만 구성된다.

### 규칙 7 — 혼복 우선배치 강제 적용
- 관리자가 혼복 우선배치 플래그를 설정한 선수는 다음 자동 매칭 시 혼복 구성에 **강제 포함**된다.
- 대기 상태인 선수에게만 설정 가능하며, 여러 선수에게 동시에 설정 가능.
- 혼복 우선배치 선수가 존재하면 일반 혼복 조건(여자 ≥ 2 + 남자 ≥ 2)을 충족하지 않더라도 혼복 구성을 우선 시도한다.
- 코트 배정이 완료되는 시점에 플래그 자동 해제.

---

## 종합 점수 공식

```
score = historyPenalty × 10 + intraDiff × 1.5 + interDiff × 0.5
```

- **점수가 낮을수록 좋은 페어링**
- 3가지 가능한 페어링 조합 중 score 최솟값 선택

---

## 스킬 점수 환산

| SkillLevel | 점수 |
|------------|------|
| O (잘함)   | 3    |
| V (보통)   | 2    |
| X (못함)   | 1    |

선수 전체 스킬 점수 = 7개 스킬 점수 합산 / 7 → 범위 1.0 ~ 3.0

---

## 대기열 선발 우선순위

1. 여자 ≥ 2명 + 남자 ≥ 2명 → 혼복 (규칙 1·2 적용해 남자 선발)
2. 여자 = 1명 + 해당 여자가 혼복허용 여성 목록에 없음 + 남자 ≥ 4명 → 남자 4명 (남복)
3. 상위 혼복·남복 규칙으로 편성 불가 + 여자 ≥ 4명 → 여자 4명 (여복)
4. 나머지 → 대기 순서대로 4명

---

## 혼복 팀 편성

- 각 팀은 반드시 여자 1 + 남자 1로 구성
- 여자와 남자의 매칭은 **파트너 중복 이력 + 스킬 균형**으로 최적 조합 선택
