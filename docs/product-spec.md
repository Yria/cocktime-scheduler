# 콕타임 (CockTime) 서비스 기획서

## 1. 서비스 개요

배드민턴 클럽의 정기 모임(세션)을 운영하는 도구.
선수 명단을 관리하고, 코트별 팀을 자동으로 구성하며, 대기/휴식 상태를 실시간으로 공유한다.

- 타깃: 배드민턴 클럽 관리자 + 참석 선수 전원
- 환경: 모바일 전용 (PC는 모바일 레이아웃 그대로)
- 실시간 동기화: 관리자 태블릿 + 참석자 개인 스마트폰이 같은 세션 화면을 공유

---

## 2. 화면 구성

### 2-1. 홈
- 구글 스프레드시트 URL 입력 → 선수 데이터 로드
- 로드된 선수 목록 확인 후 세션 설정 페이지로 이동

### 2-2. 세션 설정
- **코트 수 선택** (1~6개)
- **혼복 허용 여성 지정**: 여성 선수 중 남3여1 구성에서 단독 배치를 허용할 선수 선택
- **참석자 선택**: 전체 선수 목록에서 오늘 참석한 선수를 체크. 이름 검색, 성별 필터 지원
- **게스트 추가**: 명단에 없는 임시 참가자 추가 (이름·성별·스킬 입력)
- 세션 시작 버튼 → 세션 생성 후 코트 현황 페이지로 이동

### 2-3. 코트 현황 (세션 메인)
세션 진행 중 메인 화면.

#### 표시 영역
| 영역 | 내용 |
|------|------|
| 코트 목록 | 코트별 현재 경기 중인 팀 A / 팀 B |
| 대기 목록 | 경기 대기 중인 선수 + 누적 게임 수 |
| 예약 그룹 | 미리 지정된 그룹 (준비 완료 여부 표시) |
| 휴식 목록 | 일시 휴식 중인 선수 |

#### 액션
- **팀 생성**: 대기열에서 알고리즘으로 4명 선발 → 팀 미리보기 → 빈 코트에 배정
- **예약 생성**: 2~4명을 미리 지정. 코트에 있어도 예약 가능
- **경기 완료**: 코트 완료 처리 → 4명 대기 복귀 (예약 그룹 소속이면 해당 그룹 대기 상태로)
- **휴식 전환**: 대기↔휴식 토글
- **혼복 우선배치 지정**: 대기 중인 선수를 눌러 다음 자동 매칭에서 혼복으로 강제 배치 토글. 코트 배정이 완료되면 자동 해제
- **세션 종료**: 세션 마감, 전체 기록 저장

---

## 3. 핵심 기능 상세

### 3-1. 자동 팀 매칭 알고리즘

대기열에서 4명을 선발해 2v2 팀을 구성한다. 우선순위 순서:

#### 선발 우선순위 (4명 뽑기)
1. 누적 게임 수가 적은 선수 우선 (game_count 오름차순)
2. 동점이면 기존 대기 순서 유지

#### 게임 타입 결정
1. 대기열에 여성 ≥ 2명 + 남성 ≥ 2명 → **혼복** (여+남 vs 여+남)
2. 여성 = 1명 + 해당 여성이 혼복허용 선수 + 남성 ≥ 3명 → **혼복** (남3여1 허용)
3. 여성 = 1명 + 혼복허용 아님 + 남성 ≥ 4명 → **남복** (여성 제외 남자 4명)
4. 나머지 → 대기 순서대로 4명

#### 팀 구성 점수 공식 (낮을수록 좋음)
```
score = historyPenalty × 10 + intraDiff × 1.5 + interDiff × 0.5
```
- `historyPenalty`: 이전에 같이 뛴 파트너 중복 횟수 (pair_history)
- `intraDiff`: 같은 팀 파트너 간 실력 차이
- `interDiff`: 팀 A 총 실력 vs 팀 B 총 실력 차이

#### 혼복 남자 선발
- 혼복 출전 횟수(mixed_count)가 가장 적은 남자를 무조건 1명 이상 포함하여 우선 선발
- 횟수가 적은 선수가 소외되지 않도록, 혼복 출전 횟수 합산과 실력 차이를 종합적으로 고려하여 최적의 쌍 선택

#### 혼복 우선배치 (수동 개입)
- 관리자가 대기 중인 특정 선수에게 "혼복 우선배치" 플래그를 설정할 수 있음
- 플래그가 설정된 선수는 다음 자동 매칭 시 혼복 구성에 강제 포함
- 코트 배정이 완료되는 시점에 플래그 자동 해제
- 여러 선수에게 동시에 설정 가능

### 3-2. 예약 그룹

- 2~4명을 미리 묶어두는 기능
- 코트에서 경기 중인 선수도 예약 가능 → 경기 끝나면 자동으로 그룹 대기 상태
- 그룹 전원이 준비되면 해당 그룹을 코트에 배정 가능
- 그룹 해체 시 준비 완료된 선수만 대기열로 복귀

### 3-3. 실시간 동기화

- **Supabase Realtime Broadcast** 사용
- 모든 상태 변경(배정, 완료, 휴식 등)을 브로드캐스트로 즉시 전파
- 재연결 시 DB에서 현재 세션 상태를 쿼리하여 복구
- 자신이 보낸 이벤트는 자신에게 돌아오지 않음 (루프 없음)

---

## 4. 선수 데이터 구조

| 필드 | 타입 | 설명 |
|------|------|------|
| id | string | 구글 시트 기반 고유 ID |
| name | string | 이름 |
| gender | 'M' \| 'F' | 성별 |
| skills | object | 7가지 스킬 각 O/V/X |

#### 스킬 항목
클리어 / 스매시 / 로테이션 / 드랍 / 헤어핀 / 드라이브 / 백핸드

#### 스킬 점수
- O (잘함) = 3점
- V (보통) = 2점
- X (못함) = 1점
- 선수 실력 = 7개 스킬 점수 합산 (7~21점)

---

## 5. 선수 상태 전이

```
[waiting] ──배정──▶ [playing] ──완료──▶ [waiting]
    │                                       │
    ├──휴식──▶ [resting] ──복귀──▶ [waiting]│
    │                                       │
    └──예약──▶ [reserved] ──완료──▶ [reserved_ready] ──배정──▶ [playing]
```

- **waiting**: 대기 중, 자동 매칭 대상
- **playing**: 코트에서 경기 중
- **resting**: 일시 휴식, 매칭 대상 제외
- **reserved**: 예약 그룹 소속 (코트 경기 중이거나 대기 중)

혼복 우선배치 플래그(`force_mixed`)는 상태와 독립적으로 동작하는 속성값.
waiting 상태인 선수에게만 설정 가능하며, 배정 완료 시 자동 해제.

---

## 6. 세션 라이프사이클

```
세션 생성 → 참여자 전원 waiting 등록
    ↓
[반복] 팀 생성 → 코트 배정 → 경기 완료 → 대기 복귀
    ↓
세션 종료 → 기록 확정
```

---

## 7. 비고

- 점수 계산 없음 (팀 편성 도구)
- 세션 간 통계/히스토리는 현재 범위 외 (추후 확장)
- 게스트 선수는 구글 시트에 없는 임시 참가자 (`guest-` prefix ID)
