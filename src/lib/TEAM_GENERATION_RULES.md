# 팀 생성 알고리즘 규칙

## 개요

4명을 두 팀(2v2)으로 편성하는 알고리즘. 공정하고 다양한 경기를 위해 아래 규칙을 우선순위 순서로 적용한다.

---

## 규칙 목록

### 규칙 0 — 전체 경기 횟수 균등 분배 (최우선 선발 기준)
- 모든 선수의 경기 횟수가 비슷하도록, **경기를 적게 한 선수를 먼저 선발**한다.
- `selectFour` 진입 전에 대기열 전체를 `gameCount` 오름차순으로 정렬.
- 동점(경기수 같음)이면 기존 대기 순서 유지 (stable sort).
- 구현: `GameCountHistory[playerId]`, `recordGameCount()` 호출 시 증가.

### 규칙 1 — 혼복 우선, 남자 혼복 균등 참여
- 대기열에 여자 2명 이상 + 남자 2명 이상이 있으면 **혼복(여+남 vs 여+남)을 최우선** 구성한다.
- 남자 선수 중 **혼복 출전이 적은 선수를 우선** 선발하여, 모든 남자가 골고루 혼복을 경험하도록 한다.
- 구현: `MixedHistory[playerId]` 카운터로 추적. `recordMixedHistory()` 호출 시 혼복 남자만 카운트 증가.

### 규칙 2 — 혼복 남자 실력 유사성
- 혼복에 투입할 남자 2명은 **서로 실력이 비슷한 쌍**을 선택한다.
- 혼복 출전 횟수가 같은 후보 중에서 `|skillScore(a) - skillScore(b)|` 가 가장 작은 쌍 선택.
- 구현: `selectMenForMixed()`

### 규칙 3 — 파트너 실력 유사성 (주요 기준)
- 복식 파트너끼리 실력이 비슷할수록 좋다.
- 점수: `intraDiff = |skill(A1) - skill(A2)| + |skill(B1) - skill(B2)|`
- **낮을수록 좋음** — 가중치 1.5배 적용.

### 규칙 4 — 팀 간 실력 균형 (보조 기준)
- 비슷한 실력자끼리 같은 팀이 되는 것을 지양한다.
- 팀 A와 팀 B의 총 실력 합 차이를 최소화한다.
- 점수: `interDiff = |(skill(A1)+skill(A2)) - (skill(B1)+skill(B2))|`
- **낮을수록 좋음** — 가중치 0.5배 적용 (규칙 3보다 낮은 우선순위).
- 예시: 강자 2명 + 약자 2명 → [강,약] vs [강,약]이 [강,강] vs [약,약]보다 유리.

### 규칙 5 — 파트너 중복 최소화 (최우선 제약)
- 이전에 같이 뛴 파트너와는 되도록 다시 파트너가 되지 않도록 한다.
- 점수: `historyPenalty = partnerCount(A1, A2) + partnerCount(B1, B2)`
- **가중치 10배** — 실력 기반 규칙보다 훨씬 강한 제약.

---

## 종합 점수 공식

```
score = historyPenalty × 10 + intraDiff × 1.5 + interDiff × 0.5
```

- **점수가 낮을수록 좋은 페어링**
- 3가지 가능한 페어링 조합 중 score 최솟값 선택

---

## 스킬 점수 환산

| SkillLevel | 점수 |
|------------|------|
| O (잘함)   | 3    |
| V (보통)   | 2    |
| X (못함)   | 1    |

선수 전체 스킬 평균 = `sum(skills) / 7` → 범위 1.0 ~ 3.0

---

## 대기열 선발 우선순위 (selectFour)

1. 여자 ≥ 2명 + 남자 ≥ 2명 → 혼복 (규칙 1·2 적용해 남자 선발)
2. 여자 = 1명 + 해당 여자가 `singleWomanIds`에 없음 + 남자 ≥ 4명 → 남자 4명
3. 나머지 → 대기 순서대로 4명

---

## 혼복 팀 편성 (buildMixedTeams)

- 각 팀은 반드시 여자 1 + 남자 1로 구성
- 여자와 남자의 매칭은 **파트너 중복 이력 + 스킬 균형**으로 최적 조합 선택

---

## 리팩토링 가이드

- **경기 횟수 균등 로직 변경**: `selectFour()` 내 sort 조건 수정
- **스킬 점수 변경**: `SKILL_VALUES` 상수만 수정
- **가중치 조정**: `pairingScore()` 내 계수 수정
- **혼복 남자 선발 로직 변경**: `selectMenForMixed()` 수정
- **새 규칙 추가**: 이 문서에 규칙 기재 후 `pairingScore()` 또는 `selectFour()`에 반영
- **혼복 허용 여성 변경**: `SessionSettings.singleWomanIds: string[]` — 해당 ID를 가진 여자만 남3여1 구성에서 단독 여자로 허용. `selectFour()`와 `determineGameType()`에서 id 포함 여부로 분기
